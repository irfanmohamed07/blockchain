<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Asset Trading</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 16px; background: #0b1220; color: #e7eef7; }
    h1 { margin: 0 0 16px; }
    .card { background: #111a2b; border: 1px solid #1f2a44; border-radius: 10px; padding: 14px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    label { display: block; font-size: 12px; margin-top: 8px; color: #a9b5ca; }
    input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #253456; background: #0e1626; color: #e7eef7; }
    button { margin-top: 10px; padding: 10px 14px; background: #3a6df0; color: white; border: 0; border-radius: 8px; cursor: pointer; }
    .muted { color: #92a2bd; }
  </style>
</head>
<body>
  <h1>Digital Asset Trading</h1>

  <div class="card">
    <label for="baseUrl">Backend URL</label>
    <input id="baseUrl" placeholder="http://127.0.0.1:5001" />
    <button id="saveBaseUrl">Save</button>
    <div class="muted">Set your Render URL here in production.</div>
  </div>

  <div class="row">
    <div class="card">
      <h3>Create Wallet</h3>
      <label>Address</label>
      <input id="cw_address" placeholder="0x..." />
      <label>Balance (DAT)</label>
      <input id="cw_balance" type="number" value="5000" />
      <button id="cw_btn">Create Wallet</button>
    </div>

    <div class="card">
      <h3>Create NFT</h3>
      <label>Asset ID</label>
      <input id="ca_id" placeholder="nft_001" />
      <label>Name</label>
      <input id="ca_name" placeholder="My NFT" />
      <label>Creator Address</label>
      <input id="ca_creator" placeholder="0x..." />
      <button id="ca_btn">Mint NFT</button>
    </div>

    <div class="card">
      <h3>List & Buy</h3>
      <label>Asset ID</label>
      <input id="ls_asset" placeholder="nft_001" />
      <label>Seller</label>
      <input id="ls_seller" placeholder="0x..." />
      <label>Price (DAT)</label>
      <input id="ls_price" type="number" value="500" />
      <button id="ls_btn">List For Sale</button>
      <label style="margin-top:12px">Buyer</label>
      <input id="ba_buyer" placeholder="0x..." />
      <button id="ba_btn">Buy</button>
    </div>

    <div class="card">
      <h3>Quick Actions</h3>
      <button id="mk_btn">Marketplace</button>
      <button id="st_btn">Stats</button>
      <button id="mi_btn">Mine</button>
    </div>
  </div>

  

  <script>
    const baseUrlInput = document.getElementById('baseUrl');
    const saveBtn = document.getElementById('saveBaseUrl');

    const storageKey = 'dat_base_url';
    const defaultUrl = 'http://127.0.0.1:5001';
    baseUrlInput.value = localStorage.getItem(storageKey) || defaultUrl;

    saveBtn.onclick = () => {
      localStorage.setItem(storageKey, baseUrlInput.value.trim());
      alert('Base URL saved');
    };

    function getBase() {
      return (localStorage.getItem(storageKey) || defaultUrl).replace(/\/+$/, '');
    }

    function friendlyMessage(path, json) {
      if (json && json.error) return `Error: ${json.error}`;
      if (json && json.message) return json.message;
      if (path === '/marketplace') return `Marketplace: ${json?.total_listings ?? 0} listing(s)`;
      if (path === '/stats') return `Users: ${json?.total_users ?? 0}, Assets: ${json?.total_assets ?? 0}, Blocks: ${json?.total_blocks ?? 0}`;
      if (path === '/mine') return 'Block mined successfully';
      if (path === '/chain') return `Blockchain length: ${json?.length ?? 0}`;
      return 'Done';
    }

    async function api(method, path, body) {
      const url = `${getBase()}${path}`;
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      try {
        const res = await fetch(url, opts);
        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch {}
        if (!res.ok) { alert(data.error ? `Error: ${data.error}` : `Request failed (${res.status})`); return; }
        alert(friendlyMessage(path, data));
      } catch (e) {
        alert('Network error. Check Backend URL and CORS.');
      }
    }

    // Simple validators
    function requireValue(value, name) {
      if (!value) { alert(`${name} is required`); return false; }
      return true;
    }
    function requirePositiveNumber(num, name) {
      if (!num || isNaN(num) || Number(num) <= 0) { alert(`${name} must be > 0`); return false; }
      return true;
    }

    // Bind actions
    document.getElementById('cw_btn').onclick = () => {
      const address = document.getElementById('cw_address').value.trim();
      const balance = Number(document.getElementById('cw_balance').value || 0);
      if (!requireValue(address, 'Address')) return;
      if (!requirePositiveNumber(balance, 'Balance')) return;
      return api('POST', '/create_wallet', { user_address: address, initial_balance: balance });
    };

    document.getElementById('ca_btn').onclick = () => {
      const assetId = document.getElementById('ca_id').value.trim();
      const name = document.getElementById('ca_name').value.trim();
      const creator = document.getElementById('ca_creator').value.trim();
      if (!requireValue(assetId, 'Asset ID')) return;
      if (!requireValue(name, 'Name')) return;
      if (!requireValue(creator, 'Creator Address')) return;
      return api('POST', '/create_asset', {
        asset_id: assetId, name,
        description: '', creator_address: creator,
        asset_type: 'NFT', metadata: {}
      });
    };

    document.getElementById('ls_btn').onclick = () => {
      const assetId = document.getElementById('ls_asset').value.trim();
      const seller = document.getElementById('ls_seller').value.trim();
      const price = Number(document.getElementById('ls_price').value || 0);
      if (!requireValue(assetId, 'Asset ID')) return;
      if (!requireValue(seller, 'Seller Address')) return;
      if (!requirePositiveNumber(price, 'Price')) return;
      return api('POST', '/list_for_sale', { asset_id: assetId, seller_address: seller, price });
    };

    document.getElementById('ba_btn').onclick = () => {
      const assetId = document.getElementById('ls_asset').value.trim();
      const buyer = document.getElementById('ba_buyer').value.trim();
      if (!requireValue(assetId, 'Asset ID')) return;
      if (!requireValue(buyer, 'Buyer Address')) return;
      return api('POST', '/buy_asset', { asset_id: assetId, buyer_address: buyer });
    };

    document.getElementById('mk_btn').onclick = () => api('GET', '/marketplace');
    document.getElementById('st_btn').onclick = () => api('GET', '/stats');
    document.getElementById('mi_btn').onclick = () => api('GET', '/mine');
  </script>
</body>
</html>